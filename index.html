<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Gastos Familiares</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Estilo personalizado para un aspecto más pulido */
        body {
            background-color: #f1f5f9; /* slate-100 */
        }
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        .slide-fade-enter-active {
          transition: all 0.3s ease-out;
        }
        .slide-fade-leave-active {
          transition: all 0.3s cubic-bezier(1, 0.5, 0.8, 1);
        }
        .slide-fade-enter-from,
        .slide-fade-leave-to {
          transform: translateY(-20px);
          opacity: 0;
        }
        [v-cloak] {
            display: none;
        }
    </style>
</head>
<body>

<div id="app" class="antialiased text-slate-700" v-cloak>
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header Principal -->
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">Dashboard de Gastos</h1>
                <p class="text-slate-500">Gestiona las finanzas de tu familia.</p>
            </div>
            <div class="flex items-center flex-wrap gap-2 mt-4 sm:mt-0">
                 <!-- Grupo de botones de Datos -->
                <div class="flex items-center gap-2 border border-slate-300 rounded-lg p-1">
                     <button @click="exportData" title="Exportar datos a un archivo JSON" class="bg-white hover:bg-slate-100 text-slate-600 font-semibold py-1.5 px-3 rounded-md flex items-center text-sm">
                        <i class="fas fa-file-export mr-2"></i>
                        Exportar
                    </button>
                    <button @click="triggerImport" title="Importar datos desde un archivo JSON" class="bg-white hover:bg-slate-100 text-slate-600 font-semibold py-1.5 px-3 rounded-md flex items-center text-sm">
                        <i class="fas fa-file-import mr-2"></i>
                        Importar
                    </button>
                    <input type="file" ref="fileInput" @change="handleFileUpload" accept=".json" class="hidden">
                </div>
                 <!-- Navegación de Vistas -->
                <nav class="flex space-x-1 sm:space-x-2 bg-slate-200 p-1 rounded-lg">
                    <button @click="currentView = 'dashboard'" :class="[currentView === 'dashboard' ? 'bg-white shadow' : 'text-slate-600 hover:bg-slate-300', 'px-3 py-2 text-sm font-semibold rounded-md transition-colors']">Dashboard</button>
                    <button @click="currentView = 'charts'" :class="[currentView === 'charts' ? 'bg-white shadow' : 'text-slate-600 hover:bg-slate-300', 'px-3 py-2 text-sm font-semibold rounded-md transition-colors']">Gráficos</button>
                    <button @click="currentView = 'members'" :class="[currentView === 'members' ? 'bg-white shadow' : 'text-slate-600 hover:bg-slate-300', 'px-3 py-2 text-sm font-semibold rounded-md transition-colors']">Miembros</button>
                    <button @click="currentView = 'categories'" :class="[currentView === 'categories' ? 'bg-white shadow' : 'text-slate-600 hover:bg-slate-300', 'px-3 py-2 text-sm font-semibold rounded-md transition-colors']">Categorías</button>
                </nav>
            </div>
        </header>

        <!-- Contenido dinámico según la vista -->
        <main>
            <!-- Filtros de Fecha (visible en Dashboard y Gráficos) -->
            <section v-if="currentView === 'dashboard' || currentView === 'charts'" class="bg-white p-4 rounded-xl shadow-lg border border-slate-200 mb-8 flex flex-col sm:flex-row items-center gap-4">
                <h3 class="text-sm font-bold text-slate-600 shrink-0">Filtrar por Fecha:</h3>
                <div class="flex items-center gap-2 w-full">
                    <label for="filterStartDate" class="text-sm font-medium">Desde:</label>
                    <input type="date" v-model="filterStartDate" id="filterStartDate" class="w-full px-3 py-1.5 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div class="flex items-center gap-2 w-full">
                     <label for="filterEndDate" class="text-sm font-medium">Hasta:</label>
                    <input type="date" v-model="filterEndDate" id="filterEndDate" class="w-full px-3 py-1.5 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                 <button @click="resetDateFilters" class="w-full sm:w-auto bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-lg text-sm">Limpiar</button>
            </section>

            <!-- VISTA: DASHBOARD -->
            <div v-if="currentView === 'dashboard'">
                <div class="flex flex-col sm:flex-row justify-end items-center gap-2 mb-4">
                    <button @click="askToClearTransactions" v-if="transactions.length > 0" class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center">
                        <i class="fas fa-trash-alt mr-2"></i>
                        <span>Vaciar Lista</span>
                    </button>
                     <button @click="openTransactionForm()" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i>
                        <span>Añadir Transacción</span>
                    </button>
                </div>
                
                <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200"><div class="flex items-center"><div class="p-3 rounded-full bg-green-100"><i class="fas fa-arrow-up fa-lg text-green-600"></i></div><div class="ml-4"><h3 class="text-sm font-medium text-slate-500">Ingresos Totales</h3><p class="text-2xl font-bold text-green-600">{{ formatCurrency(totalIncome) }}</p></div></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200"><div class="flex items-center"><div class="p-3 rounded-full bg-red-100"><i class="fas fa-arrow-down fa-lg text-red-600"></i></div><div class="ml-4"><h3 class="text-sm font-medium text-slate-500">Gastos Totales</h3><p class="text-2xl font-bold text-red-600">{{ formatCurrency(totalExpense) }}</p></div></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200"><div class="flex items-center"><div class="p-3 rounded-full bg-blue-100"><i class="fas fa-wallet fa-lg text-blue-600"></i></div><div class="ml-4"><h3 class="text-sm font-medium text-slate-500">Balance Actual</h3><p class="text-2xl font-bold" :class="{'text-red-600': balance < 0, 'text-green-600': balance >= 0}">{{ formatCurrency(balance) }}</p></div></div></div>
                </section>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <h2 class="text-xl font-bold mb-4 text-slate-800">Transacciones Recientes</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="border-b-2 border-slate-200">
                                        <th class="py-3 px-2 font-semibold text-sm text-slate-500">Descripción</th>
                                        <th class="py-3 px-2 font-semibold text-sm text-slate-500 hidden sm:table-cell">Miembro</th>
                                        <th class="py-3 px-2 font-semibold text-sm text-slate-500 hidden md:table-cell">Categoría</th>
                                        <th class="py-3 px-2 font-semibold text-sm text-slate-500 text-right">Monto</th>
                                        <th class="py-3 px-2 font-semibold text-sm text-slate-500 text-center"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-if="filteredTransactions.length === 0"><td colspan="5" class="text-center py-8 text-slate-500">No hay transacciones en el rango seleccionado.</td></tr>
                                    <template v-for="group in groupedTransactions" :key="group.date">
                                        <tr class="bg-slate-100 sticky top-0">
                                            <td colspan="5" class="py-2 px-2 text-sm font-bold text-slate-600 capitalize">
                                                {{ formatDateHeader(group.date) }}
                                            </td>
                                        </tr>
                                        <tr v-for="t in group.transactions" :key="t.id" class="border-b border-slate-100 hover:bg-slate-50">
                                            <td class="py-3 px-2"><p class="font-medium text-slate-800">{{ t.description }}</p><p v-if="t.detail" class="text-xs text-slate-500 mt-1 italic">{{ t.detail }}</p><span class="block sm:hidden text-xs text-slate-400 mt-1">{{ t.member }}</span></td>
                                            <td class="py-3 px-2 hidden sm:table-cell">{{ t.member }}</td>
                                            <td class="py-3 px-2 hidden md:table-cell"><span v-if="t.type === 'expense'" class="px-2 py-1 text-xs rounded-full font-medium" :style="{ backgroundColor: getCategoryColor(t.category, 0.2), color: getCategoryColor(t.category, 1) }">{{ t.category }}</span></td>
                                            <td class="py-3 px-2 text-right font-mono" :class="t.type === 'income' ? 'text-green-600' : 'text-red-600'">{{ t.type === 'income' ? '+' : '-' }} {{ formatCurrency(t.amount, false) }}</td>
                                            <td class="py-3 px-2 text-center"><div class="flex justify-center items-center gap-3"><button @click="editTransaction(t)" class="text-slate-400 hover:text-blue-500 transition-colors"><i class="fas fa-pencil-alt"></i></button><button @click="askToDeleteTransaction(t.id)" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fas fa-trash-alt"></i></button></div></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <aside class="bg-white p-6 rounded-xl shadow-lg border border-slate-200"><h2 class="text-xl font-bold mb-4 text-slate-800">Gastos por Categoría</h2><div v-if="totalExpense > 0" class="space-y-4"><div v-for="(amount, category) in expensesByCategory" :key="category"><div class="flex justify-between items-center mb-1"><span class="text-sm font-medium">{{ category }}</span><span class="text-sm font-mono">{{ formatCurrency(amount) }}</span></div><div class="w-full bg-slate-200 rounded-full h-2.5"><div class="h-2.5 rounded-full" :style="{ width: (amount / totalExpense * 100) + '%', backgroundColor: getCategoryColor(category, 1) }"></div></div></div></div><div v-else class="text-center py-8 text-slate-500"><p>No hay gastos registrados.</p></div></aside>
                </div>
            </div>

            <!-- VISTA: GRÁFICOS -->
            <div v-if="currentView === 'charts'">
                <div v-if="totalExpense === 0" class="text-center py-16 text-slate-500 bg-white rounded-xl shadow-lg">
                    <i class="fas fa-chart-pie fa-3x mb-4 text-slate-400"></i>
                    <h3 class="text-xl font-bold">No hay datos de gastos para mostrar.</h3>
                    <p>Añade algunas transacciones de gastos para ver los gráficos.</p>
                </div>
                <div v-else class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <h2 class="text-xl font-bold mb-4 text-slate-800">Gastos por Categoría</h2>
                        <canvas ref="categoryChartCanvas"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <h2 class="text-xl font-bold mb-4 text-slate-800">Gastos por Miembro</h2>
                        <canvas ref="memberChartCanvas"></canvas>
                    </div>
                </div>
            </div>

            <!-- VISTA: GESTIONAR MIEMBROS -->
            <div v-if="currentView === 'members'">
                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-slate-200">
                    <h2 class="text-xl font-bold mb-6 text-slate-800">Gestionar Miembros de la Familia</h2>
                    <form @submit.prevent="saveMember" class="flex flex-col sm:flex-row items-end gap-4 mb-8 p-4 bg-slate-50 rounded-lg"><div class="w-full"><label for="memberName" class="block text-sm font-medium text-slate-600 mb-1">Nombre del Miembro</label><input v-model="memberForm.name" type="text" id="memberName" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: Abuela" required></div><div class="flex gap-2 w-full sm:w-auto"><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex-grow">{{ memberForm.isEditing ? 'Actualizar' : 'Añadir' }}</button><button v-if="memberForm.isEditing" @click="cancelEditMember" type="button" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button></div></form>
                    <ul class="space-y-3"><li v-if="members.length === 0" class="text-center py-8 text-slate-500">No hay miembros añadidos.</li><li v-for="member in members" :key="member" class="flex justify-between items-center p-3 bg-white border border-slate-200 rounded-lg hover:shadow-sm"><span class="font-medium text-slate-700">{{ member }}</span><div class="flex gap-4"><button @click="editMember(member)" class="text-slate-500 hover:text-blue-600"><i class="fas fa-pencil-alt"></i></button><button @click="askToDeleteMember(member)" class="text-slate-500 hover:text-red-600"><i class="fas fa-trash-alt"></i></button></div></li></ul>
                </div>
            </div>

            <!-- VISTA: GESTIONAR CATEGORÍAS -->
            <div v-if="currentView === 'categories'">
                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-slate-200">
                    <h2 class="text-xl font-bold mb-6 text-slate-800">Gestionar Categorías</h2>
                    <form @submit.prevent="saveCategory" class="flex flex-col sm:flex-row items-end gap-4 mb-8 p-4 bg-slate-50 rounded-lg"><div class="w-full"><label for="categoryName" class="block text-sm font-medium text-slate-600 mb-1">Nombre de la Categoría</label><input v-model="categoryForm.name" type="text" id="categoryName" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: Supermercado" required></div><div class="w-full sm:w-auto"><label for="categoryColor" class="block text-sm font-medium text-slate-600 mb-1">Color</label><input v-model="categoryForm.color" type="color" id="categoryColor" class="w-full h-10 px-1 py-1 border border-slate-300 rounded-lg cursor-pointer"></div><div class="flex gap-2 w-full sm:w-auto shrink-0"><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex-grow">{{ categoryForm.isEditing ? 'Actualizar' : 'Añadir' }}</button><button v-if="categoryForm.isEditing" @click="cancelEditCategory" type="button" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button></div></form>
                    <ul class="space-y-3"><li v-if="categories.length === 0" class="text-center py-8 text-slate-500">No hay categorías añadidas.</li><li v-for="cat in categories" :key="cat.name" class="flex justify-between items-center p-3 bg-white border border-slate-200 rounded-lg hover:shadow-sm"><div class="flex items-center gap-3"><span class="block w-5 h-5 rounded-full border border-slate-200" :style="{ backgroundColor: cat.color }"></span><span class="font-medium text-slate-700">{{ cat.name }}</span></div><div class="flex gap-4"><button @click="editCategory(cat)" class="text-slate-500 hover:text-blue-600 transition-colors"><i class="fas fa-pencil-alt"></i></button><button @click="askToDeleteCategory(cat.name)" class="text-slate-500 hover:text-red-600 transition-colors"><i class="fas fa-trash-alt"></i></button></div></li></ul>
                </div>
            </div>
        </main>

        <!-- MODAL: FORMULARIO DE TRANSACCIÓN -->
        <transition name="fade">
            <div v-if="showTransactionForm" @click.self="showTransactionForm = false" class="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4">
                <transition name="slide-fade">
                    <div v-if="showTransactionForm" class="bg-white rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-lg">
                        <h2 class="text-2xl font-bold mb-6 text-slate-800">{{ transactionForm.isEditing ? 'Editar' : 'Nueva' }} Transacción</h2>
                        <form @submit.prevent="saveTransaction">
                             <div class="mb-4"><label for="description" class="block text-sm font-medium text-slate-600 mb-1">Descripción</label><input v-model="transactionForm.description" type="text" id="description" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: Compra del supermercado" required></div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                <div><label for="amount" class="block text-sm font-medium text-slate-600 mb-1">Monto</label><input v-model.number="transactionForm.amount" type="number" step="0.01" id="amount" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="0.00" required></div>
                                <div><label for="date" class="block text-sm font-medium text-slate-600 mb-1">Fecha</label><input v-model="transactionForm.date" type="date" id="date" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required></div>
                            </div>
                            <div class="mb-4"><label for="detail" class="block text-sm font-medium text-slate-600 mb-1">Detalle (Opcional)</label><textarea v-model="transactionForm.detail" id="detail" rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Añade notas adicionales aquí..."></textarea></div>
                            <div class="mb-4"><span class="block text-sm font-medium text-slate-600 mb-2">Tipo</span><div class="flex space-x-4"><label class="flex items-center"><input v-model="transactionForm.type" type="radio" value="expense" name="type" class="form-radio h-4 w-4 text-red-600"><span class="ml-2 text-red-700 font-semibold">Gasto</span></label><label class="flex items-center"><input v-model="transactionForm.type" type="radio" value="income" name="type" class="form-radio h-4 w-4 text-green-600"><span class="ml-2 text-green-700 font-semibold">Ingreso</span></label></div></div>
                            <div v-if="transactionForm.type === 'expense'" class="mb-4"><label for="category" class="block text-sm font-medium text-slate-600 mb-1">Categoría</label><select v-model="transactionForm.category" id="category" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required><option disabled value="">Selecciona una categoría</option><option v-for="cat in categories" :key="cat.name" :value="cat.name">{{ cat.name }}</option></select></div>
                            <div class="mb-6"><label for="member" class="block text-sm font-medium text-slate-600 mb-1">Miembro</label><select v-model="transactionForm.member" id="member" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required><option disabled value="">Selecciona un miembro</option><option v-for="member in members" :key="member" :value="member">{{ member }}</option></select></div>
                            <div class="flex justify-end space-x-4"><button @click="showTransactionForm = false" type="button" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded-lg">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-sm">Guardar</button></div>
                        </form>
                    </div>
                </transition>
            </div>
        </transition>

        <!-- MODAL: CONFIRMACIÓN -->
        <transition name="fade">
            <div v-if="showConfirmModal" @click.self="cancelConfirm" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                <transition name="slide-fade">
                    <div v-if="showConfirmModal" class="bg-white rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-md text-center">
                        <h3 class="text-xl font-bold mb-4 text-slate-800">{{ confirmModalProps.title }}</h3>
                        <p class="text-slate-600 mb-6">{{ confirmModalProps.message }}</p>
                        <div class="flex justify-center space-x-4">
                            <button @click="cancelConfirm" class="px-6 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded-lg">Cancelar</button>
                            <button @click="executeConfirm" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg shadow-sm">Confirmar</button>
                        </div>
                    </div>
                </transition>
            </div>
        </transition>
    </div>
</div>

<script>
const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

const App = {
    setup() {
        // --- STATE ---
        const currentView = ref('dashboard');
        const transactions = ref([]);
        const members = ref([]);
        const categories = ref([]);
        const filterStartDate = ref('');
        const filterEndDate = ref('');
        
        // --- MODAL & FORM STATE ---
        const showTransactionForm = ref(false);
        const showConfirmModal = ref(false);
        const confirmModalProps = ref({ title: '', message: '', onConfirm: () => {} });
        
        const transactionForm = ref({});
        const memberForm = ref({ name: '', isEditing: false, originalName: '' });
        const categoryForm = ref({ name: '', color: '#94a3b8', isEditing: false, originalName: '' });

        // --- REFS FOR DOM & CHARTS ---
        const fileInput = ref(null);
        const categoryChartCanvas = ref(null);
        const memberChartCanvas = ref(null);
        let categoryChartInstance = null;
        let memberChartInstance = null;


        const getInitialTransactionForm = () => ({
            id: null, description: '', amount: null, type: 'expense', category: '', member: '',
            date: new Date().toISOString().slice(0, 10), detail: '', isEditing: false,
        });

        
        // --- COMPUTED PROPERTIES ---
        const filteredTransactions = computed(() => {
            return transactions.value.filter(t => {
                const transactionDate = new Date(t.date);
                const startDate = filterStartDate.value ? new Date(filterStartDate.value) : null;
                const endDate = filterEndDate.value ? new Date(filterEndDate.value) : null;
                if(startDate) startDate.setUTCHours(0,0,0,0);
                if(endDate) endDate.setUTCHours(23,59,59,999);
                if (startDate && transactionDate < startDate) return false;
                if (endDate && transactionDate > endDate) return false;
                return true;
            });
        });

        const totalIncome = computed(() => filteredTransactions.value.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0));
        const totalExpense = computed(() => filteredTransactions.value.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0));
        const balance = computed(() => totalIncome.value - totalExpense.value);
        
        const expensesByCategory = computed(() => {
            return filteredTransactions.value.filter(t => t.type === 'expense').reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + t.amount;
                return acc;
            }, {});
        });

        const expensesByMember = computed(() => {
            return filteredTransactions.value.filter(t => t.type === 'expense').reduce((acc, t) => {
                acc[t.member] = (acc[t.member] || 0) + t.amount;
                return acc;
            }, {});
        });

        const groupedTransactions = computed(() => {
            const sorted = [...filteredTransactions.value].sort((a, b) => new Date(b.date) - new Date(a.date));
            const groups = sorted.reduce((acc, transaction) => {
                const date = transaction.date;
                if (!acc[date]) acc[date] = [];
                acc[date].push(transaction);
                return acc;
            }, {});
            return Object.keys(groups).map(date => ({ date: date, transactions: groups[date] }));
        });

        // --- LIFECYCLE & WATCHERS ---
        onMounted(() => {
            transactionForm.value = getInitialTransactionForm();
            loadAllData();
        });

        watch(currentView, (newView) => {
            if (newView === 'charts') {
                renderCharts();
            } else {
                destroyCharts();
            }
        });

        watch(filteredTransactions, () => {
            if (currentView.value === 'charts') {
                renderCharts();
            }
        });

        // --- CHART METHODS ---
        const destroyCharts = () => {
            if (categoryChartInstance) {
                categoryChartInstance.destroy();
                categoryChartInstance = null;
            }
            if (memberChartInstance) {
                memberChartInstance.destroy();
                memberChartInstance = null;
            }
        };
        
        const renderCharts = async () => {
            await nextTick(); // Wait for DOM to be updated
            destroyCharts();

            if (totalExpense.value === 0) return;

            // Category Chart (Doughnut)
            if (categoryChartCanvas.value) {
                const categoryData = Object.keys(expensesByCategory.value);
                const categoryValues = Object.values(expensesByCategory.value);
                categoryChartInstance = new Chart(categoryChartCanvas.value, {
                    type: 'doughnut',
                    data: {
                        labels: categoryData,
                        datasets: [{
                            data: categoryValues,
                            backgroundColor: categoryData.map(cat => getCategoryColor(cat, 0.8)),
                            borderColor: '#ffffff',
                            borderWidth: 2,
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'bottom' }}}
                });
            }

            // Member Chart (Bar)
            if (memberChartCanvas.value) {
                const memberData = Object.keys(expensesByMember.value);
                const memberValues = Object.values(expensesByMember.value);
                memberChartInstance = new Chart(memberChartCanvas.value, {
                    type: 'bar',
                    data: {
                        labels: memberData,
                        datasets: [{
                            label: 'Gasto Total',
                            data: memberValues,
                            backgroundColor: memberData.map((_, i) => `hsla(${i * 45}, 70%, 60%, 0.8)`),
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false }}, scales: { y: { beginAtZero: true }}}
                });
            }
        };

        // --- LOCALSTORAGE & DATA METHODS ---
        const saveAllData = () => {
            localStorage.setItem('family-transactions', JSON.stringify(transactions.value));
            localStorage.setItem('family-members', JSON.stringify(members.value));
            localStorage.setItem('family-categories', JSON.stringify(categories.value));
        };

        const loadAllData = () => {
             const savedTransactions = localStorage.getItem('family-transactions');
            transactions.value = savedTransactions ? JSON.parse(savedTransactions) : [];
            const savedMembers = localStorage.getItem('family-members');
            members.value = savedMembers ? JSON.parse(savedMembers) : ['Padre', 'Madre', 'Hijo', 'Hija', 'Familia'];
            const savedCategories = localStorage.getItem('family-categories');
            categories.value = savedCategories ? JSON.parse(savedCategories) : [{ name: 'Comida', color: '#4ade80' }, { name: 'Transporte', color: '#60a5fa' }, { name: 'Vivienda', color: '#facc15' }, { name: 'Ocio', color: '#fb923c' }, { name: 'Salud', color: '#f87171' }, { name: 'Educación', color: '#c084fc' }, { name: 'Ropa', color: '#ec4899' }, { name: 'Otros', color: '#94a3b8' }];
        }

        const exportData = () => {
            const dataToExport = { transactions: transactions.value, members: members.value, categories: categories.value };
            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `dashboard-gastos-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        const triggerImport = () => { fileInput.value.click(); };

        const handleFileUpload = (event) => {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData && importedData.transactions && importedData.members && importedData.categories) {
                        confirmModalProps.value = { title: 'Importar Datos', message: 'Esto reemplazará todos los datos actuales. ¿Deseas continuar?',
                            onConfirm: () => {
                                transactions.value = importedData.transactions; members.value = importedData.members; categories.value = importedData.categories;
                                saveAllData();
                            }};
                        showConfirmModal.value = true;
                    } else { alert('El archivo no tiene el formato correcto.'); }
                } catch (error) { alert('Error al leer el archivo. Asegúrate de que sea un archivo JSON válido.');
                } finally { event.target.value = ''; }
            };
            reader.readAsText(file);
        };
        
        // --- CONFIRMATION MODAL METHODS ---
        const executeConfirm = () => { confirmModalProps.value.onConfirm(); showConfirmModal.value = false; };
        const cancelConfirm = () => { showConfirmModal.value = false; };

        // --- TRANSACTION METHODS ---
        const openTransactionForm = () => { transactionForm.value = getInitialTransactionForm(); showTransactionForm.value = true; };
        const saveTransaction = () => {
            const form = transactionForm.value;
            if (!form.description || !form.amount || !form.member || !form.date) return;
            if (form.type === 'expense' && !form.category) return;
            if (form.isEditing) {
                const index = transactions.value.findIndex(t => t.id === form.id);
                if (index !== -1) { transactions.value[index] = { ...form, category: form.type === 'income' ? 'Ingreso' : form.category }; }
            } else { transactions.value.unshift({ ...form, id: Date.now(), category: form.type === 'income' ? 'Ingreso' : form.category }); }
            saveAllData(); showTransactionForm.value = false;
        };
        const editTransaction = (transaction) => { transactionForm.value = { ...transaction, isEditing: true }; showTransactionForm.value = true; };
        const askToDeleteTransaction = (id) => { confirmModalProps.value = { title: 'Eliminar Transacción', message: '¿Estás seguro de que quieres eliminar esta transacción?', onConfirm: () => deleteTransaction(id) }; showConfirmModal.value = true; };
        const deleteTransaction = (id) => { transactions.value = transactions.value.filter(t => t.id !== id); saveAllData(); };
        const askToClearTransactions = () => { confirmModalProps.value = { title: 'Vaciar Lista de Transacciones', message: '¿Estás seguro de que quieres eliminar TODAS las transacciones? Esta acción no se puede deshacer.', onConfirm: clearAllTransactions }; showConfirmModal.value = true; };
        const clearAllTransactions = () => { transactions.value = []; saveAllData(); };

        // --- MEMBER METHODS ---
        const saveMember = () => {
            const newName = memberForm.value.name.trim(); if (!newName) return;
            if (memberForm.value.isEditing) {
                const oldName = memberForm.value.originalName;
                if (newName !== oldName && members.value.includes(newName)) { alert('Este nombre de miembro ya existe.'); return; }
                const index = members.value.findIndex(m => m === oldName);
                if (index !== -1) { members.value[index] = newName; transactions.value.forEach(t => { if (t.member === oldName) t.member = newName; }); }
            } else { if (members.value.includes(newName)) { alert('Este miembro ya existe.'); return; } members.value.push(newName); }
            saveAllData(); cancelEditMember();
        };
        const editMember = (memberName) => { memberForm.value.name = memberName; memberForm.value.originalName = memberName; memberForm.value.isEditing = true; };
        const cancelEditMember = () => { memberForm.value.name = ''; memberForm.value.isEditing = false; memberForm.value.originalName = ''; };
        const askToDeleteMember = (memberName) => {
            if (transactions.value.some(t => t.member === memberName)) { alert(`No se puede eliminar a "${memberName}" porque tiene transacciones asociadas. Por favor, reasigna o elimina sus transacciones primero.`); return; }
            confirmModalProps.value = { title: 'Eliminar Miembro', message: `¿Estás seguro de que quieres eliminar a "${memberName}"?`, onConfirm: () => deleteMember(memberName) };
            showConfirmModal.value = true;
        };
        const deleteMember = (memberName) => { members.value = members.value.filter(m => m !== memberName); saveAllData(); };
        
        // --- CATEGORY METHODS ---
        const saveCategory = () => {
            const newName = categoryForm.value.name.trim(); if (!newName) return;
            if (categoryForm.value.isEditing) {
                const oldName = categoryForm.value.originalName;
                if (newName !== oldName && categories.value.some(c => c.name === newName)) { alert('Ese nombre de categoría ya existe.'); return; }
                const category = categories.value.find(c => c.name === oldName);
                if (category) {
                    category.name = newName; category.color = categoryForm.value.color;
                    transactions.value.forEach(t => { if (t.category === oldName) t.category = newName; });
                }
            } else { if (categories.value.some(c => c.name === newName)) { alert('Ese nombre de categoría ya existe.'); return; } categories.value.push({ name: newName, color: categoryForm.value.color }); }
            saveAllData(); cancelEditCategory();
        };
        const editCategory = (category) => {
            categoryForm.value.name = category.name; categoryForm.value.color = category.color;
            categoryForm.value.originalName = category.name; categoryForm.value.isEditing = true;
        };
        const cancelEditCategory = () => {
            categoryForm.value.name = ''; categoryForm.value.color = '#94a3b8';
            categoryForm.value.isEditing = false;
            categoryForm.value.originalName = '';
        };
        const askToDeleteCategory = (categoryName) => {
            if (transactions.value.some(t => t.category === categoryName)) { alert(`No se puede eliminar "${categoryName}" porque tiene transacciones asociadas.`); return; }
            confirmModalProps.value = { title: 'Eliminar Categoría', message: `¿Estás seguro de que quieres eliminar la categoría "${categoryName}"?`, onConfirm: () => deleteCategory(categoryName) };
            showConfirmModal.value = true;
        };
        const deleteCategory = (categoryName) => { categories.value = categories.value.filter(c => c.name !== categoryName); saveAllData(); };

        // --- UTILITY METHODS ---
        const resetDateFilters = () => { filterStartDate.value = ''; filterEndDate.value = ''; };
        const formatCurrency = (value, includeSymbol = true) => {
            const options = { style: 'currency', currency: 'PEN', minimumFractionDigits: 2 };
            return new Intl.NumberFormat('es-PE', includeSymbol ? options : { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value || 0);
        };
        const formatDateHeader = (dateString) => {
            const today = new Date(); const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const parts = dateString.split('-');
            const transactionDate = new Date(parts[0], parts[1] - 1, parts[2]);
            if (today.toDateString() === transactionDate.toDateString()) return 'Hoy';
            if (yesterday.toDateString() === transactionDate.toDateString()) return 'Ayer';
            return new Intl.DateTimeFormat('es-ES', { dateStyle: 'full' }).format(transactionDate);
        };
        const getCategoryColor = (categoryName, opacity = 1) => {
            const category = categories.value.find(c => c.name === categoryName);
            const hexColor = category ? category.color : '#94a3b8';
            let r=0,g=0,b=0;
            if(hexColor.length==7){r=parseInt(hexColor.substring(1,3),16);g=parseInt(hexColor.substring(3,5),16);b=parseInt(hexColor.substring(5,7),16);}
            return `rgba(${r},${g},${b},${opacity})`;
        };

        return { currentView, transactions, members, categories, showTransactionForm, transactionForm, memberForm, categoryForm, totalIncome, totalExpense, balance, expensesByCategory, saveTransaction, editTransaction, deleteTransaction, saveMember, editMember, deleteMember, saveCategory, editCategory, deleteCategory, formatCurrency, getCategoryColor, groupedTransactions, formatDateHeader, openTransactionForm, saveAllData, showConfirmModal, confirmModalProps, executeConfirm, cancelConfirm, askToDeleteTransaction, askToClearTransactions, askToDeleteMember, askToDeleteCategory, filterStartDate, filterEndDate, filteredTransactions, resetDateFilters, exportData, triggerImport, handleFileUpload, fileInput, categoryChartCanvas, memberChartCanvas };
    }
};
createApp(App).mount('#app');
</script>

</body>
</html>
